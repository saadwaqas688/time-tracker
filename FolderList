package org.example;
import javax.swing.*;
import javax.swing.plaf.basic.BasicScrollBarUI;
import javax.swing.table.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.sql.*;
import java.util.*;
import java.util.List;
import java.util.Timer;
import org.json.JSONArray;
import org.json.JSONObject;
import org.jnativehook.GlobalScreen;
import org.jnativehook.NativeHookException;
import java.io.IOException;
import java.util.Timer;
import java.util.TimerTask;
import javax.swing.SwingUtilities;
import javax.swing.table.DefaultTableModel;

import java.awt.Toolkit;




public class FolderList extends JFrame {
    private JPanel folderPanel;
    private JPanel taskPanelR;

    private JPanel currentTaskPanel;
    private JScrollPane folderScrollPane;
    private JScrollPane taskScrollPane;
    private JButton addButton;
    private List<Project> projects;
    private String selectedProjectId;
    private String selectedTaskId;
    private long lastDatabaseUpdate = 0; // Field to track the last database update time
    private static final long UPDATE_INTERVAL_MS = 10000;
    private static final String DB_URL = "jdbc:sqlite:current.db";


    private Timer timer;
    private Task currentTask;
    private Project currentProject;
    private JLabel startIconGlobalTimer;
    private JLabel stopIconGlobalTimer;

    private JLabel currentTaskLabel;
    private JLabel currentTaskDetailsLabel;
    private JButton startButton;
    private JButton stopButton;

    private long elapsedTimeBeforeStop = 0;

    //

    /* Base colors */
    public static final Color SECONDARY_COLOR = new Color(0, 36, 51);
    public static final Color PRIMARY_COLOR = new Color(3, 50, 70);
    public static final Color PRIMARY_TEXT_COLOR = new Color(255, 255, 255);

    /* Status colors */
    public static final Color SUCCESS_COLOR = new Color(17, 235, 130);
    public static final Color INFO_COLOR = new Color(122, 142, 248);
    public static final Color WARNING_COLOR = new Color(244, 162, 97);
    public static final Color ERROR_COLOR = new Color(251, 93, 93);
    public static final Color ACCENT_COLOR = new Color(231, 111, 81);
    private static final Color DARK_ORANGE = new Color(193,193,215);
    //

    private static final Color LIGHT_BLUE = new Color(173, 216, 230);
    private static final Color DARK_BLUE = new Color(153, 204, 255);

    //
    private static final Color GREEN = new Color(0, 255, 0);
    private static final Color TIMER_COLOR = new Color(0, 128, 0);
    private static final Color ADD_PROJECT_COLOR = new Color(0, 0, 0);
    private static final Color FOLDER_COLOR = new Color(255, 204, 204);
    private static final Color SEARCH_COLOR = new Color(204, 255, 204);
    private static final Color TASK_PANEL_COLOR = new Color(204, 204, 255);
    private static final Color ADD_PROJECT_PANEL_COLOR = new Color(204, 255, 204);
    private static final Color MAIN_WINDOW_COLOR = new Color(0, 36, 51); // Red color for the main window
    private int currentTaskRowIndex = -1; // Default to -1 (no task selected)
    private JTable taskTable;

    private static final int MARGIN_SIZE = 5;
    //

    private Timer idleTimer;


    private JLabel globalTimerLabel;
    private JButton startButtonGlobalTimer;
    private JButton stopButtonGlobalTimer;

    private Timer globalTimer;
    private long globalStartTime;
    private boolean isGlobalTimerRunning;
    private GlobalEventListener listener;
    private boolean isDefaultSelectedTaskRunning;


    //    private static FolderList instance;
//    // Static method to get the singleton instance
//    public static FolderList getInstance() {
//        if (instance == null) {
//            instance = new FolderList();
//        }
//        return instance;
//    }
    FolderList() {




        startGlobalEventListener();
        setTitle("Custom Window");
        setSize(1200, 800);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        JPanel mainPanel = new JPanel(new BorderLayout(MARGIN_SIZE, MARGIN_SIZE));
        mainPanel.setBackground(PRIMARY_COLOR);

        addSidePanel(mainPanel);


        JPanel centerPanel = createCenterPanel();


        centerPanel.add(createTimerPanel());

        centerPanel.add(Box.createVerticalStrut(MARGIN_SIZE));

        // Add Project Panel


        centerPanel.add(createAddProjectPanel());

        centerPanel.add(Box.createVerticalStrut(MARGIN_SIZE));

        // Folder Panel

        centerPanel.add(createFolderPanel());

        centerPanel.add(Box.createVerticalStrut(MARGIN_SIZE)); // Add vertical gap


        centerPanel.add(createSearchPanel());



        projects = fetchProjects();


        if(isGlobalTimerRunning){
            startGlobalTimer();

        }



        timer = new Timer();



        populateFolders();
        if (selectedProjectId != null ) {
            showTasks(selectedProjectId);
        }

        // Task Panel

        centerPanel.add(createTaskPanel());
        mainPanel.add(centerPanel, BorderLayout.CENTER);



        add(mainPanel, BorderLayout.CENTER);

        setVisible(true);

        addComponentListener(new java.awt.event.ComponentAdapter() {
            public void componentResized(java.awt.event.ComponentEvent evt) {
                onWindowResize();
            }
        });

        if (isDefaultSelectedTaskRunning) {
            startTimer(currentTask);
        }
    }

    private JPanel createCenterPanel() {
        JPanel centerPanel = new JPanel();
        centerPanel.setLayout(new BoxLayout(centerPanel, BoxLayout.Y_AXIS)); // Use BoxLayout for vertical stacking
        centerPanel.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE));
        centerPanel.setBackground(PRIMARY_COLOR);
        return centerPanel;
    }









    private JPanel createTimerPanel() {
        JPanel timerPanel = new JPanel();
        timerPanel.setPreferredSize(new Dimension(getWidth(), 48)); // Fixed height of 48 pixels
        timerPanel.setBackground(SECONDARY_COLOR);
        timerPanel.setLayout(new BorderLayout());
        timerPanel.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE));

        // Current Task Labels
        currentTaskLabel = new JLabel("Project Name");
        currentTaskLabel.setHorizontalAlignment(SwingConstants.LEFT);
        currentTaskLabel.setFont(new Font("Arial", Font.PLAIN, 15)); // Adjust font name and size as needed
        Font boldFont1 = currentTaskLabel.getFont().deriveFont(Font.BOLD);
        currentTaskLabel.setFont(boldFont1);



        currentTaskDetailsLabel = new JLabel("No task selected");
        currentTaskLabel.setForeground(PRIMARY_TEXT_COLOR); // Set text color
        currentTaskDetailsLabel.setForeground(PRIMARY_TEXT_COLOR); // Set text color

        // Add spacing between project name and task details
        currentTaskDetailsLabel.setBorder(BorderFactory.createEmptyBorder(5, 0, 0, 0)); // Adds top margin of 5 pixels

        // Panel for Task Information
        JPanel taskInfoPanel = new JPanel();
        taskInfoPanel.setLayout(new BoxLayout(taskInfoPanel, BoxLayout.Y_AXIS)); // Stack components vertically
        taskInfoPanel.setBackground(SECONDARY_COLOR); // Match timer panel color
        taskInfoPanel.setOpaque(false); // Make transparent
        taskInfoPanel.add(currentTaskLabel);
        taskInfoPanel.add(currentTaskDetailsLabel);
        taskInfoPanel.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE)); // Add padding

        // Timer Label
        globalTimerLabel = new JLabel("00:00:00", SwingConstants.LEFT);
        globalTimerLabel.setForeground(PRIMARY_TEXT_COLOR); // Set text color
        globalTimerLabel.setFont(new Font("Arial", Font.PLAIN, 24)); // Adjust font name and size as needed
        Font boldFont = globalTimerLabel.getFont().deriveFont(Font.BOLD);
        globalTimerLabel.setFont(boldFont);
        globalTimerLabel.setOpaque(false); // Make label transparent

        // Load icons for start and stop
        ImageIcon startIcon = loadImageIcon("icons/small-start-icon.png", 30, 30); // Adjust path and size as needed
        ImageIcon stopIcon = loadImageIcon("icons/small-pause-con.png", 30, 30);   // Adjust path and size as needed

        // Start Icon
        startIconGlobalTimer = new JLabel();
        if (startIcon != null) {
            startIconGlobalTimer.setIcon(startIcon); // Set the icon
        }
        startIconGlobalTimer.setPreferredSize(new Dimension(30, 30)); // Set preferred size
        startIconGlobalTimer.setOpaque(false); // Make label transparent
        startIconGlobalTimer.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                startGlobalTimer();
            }
        });

        // Stop Icon
        stopIconGlobalTimer = new JLabel();
        if (stopIcon != null) {
            stopIconGlobalTimer.setIcon(stopIcon); // Set the icon
        }
        stopIconGlobalTimer.setPreferredSize(new Dimension(30, 30)); // Set preferred size
        stopIconGlobalTimer.setOpaque(false); // Make label transparent
        stopIconGlobalTimer.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                stopGlobalTimer();
            }
        });

        // Initially, make the stop icon invisible
        stopIconGlobalTimer.setVisible(true);
        stopIconGlobalTimer.setVisible(false);

        // Panel for Timer and Icons
        JPanel timerAndIconsPanel = new JPanel();
        timerAndIconsPanel.setLayout(new GridBagLayout());
        timerAndIconsPanel.setBackground(SECONDARY_COLOR); // Set background color
        timerAndIconsPanel.setOpaque(false); // Make transparent
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(0, 5, 0, 5); // Spacing between components
        gbc.anchor = GridBagConstraints.WEST;

        // Add Timer Label
        gbc.gridx = 0;
        gbc.gridy = 0;
        timerAndIconsPanel.add(globalTimerLabel, gbc);

        // Add Start Icon
        gbc.gridx = 1;
        timerAndIconsPanel.add(startIconGlobalTimer, gbc);

        // Add Stop Icon
        gbc.gridx = 2;
        timerAndIconsPanel.add(stopIconGlobalTimer, gbc);

        // Username Label
        JLabel userAvatar = FolderListUtils.createUserAvatar("images/nabeel.jpg", "Username");


        // Panel to align Timer and Icons
        JPanel rightPanel = new JPanel();
        rightPanel.setLayout(new BorderLayout());
        rightPanel.add(timerAndIconsPanel, BorderLayout.CENTER);
        rightPanel.add(userAvatar, BorderLayout.EAST);
        rightPanel.setBackground(SECONDARY_COLOR); // Set background color
        rightPanel.setOpaque(false); // Make transparent

        // Add Components to Timer Panel
        timerPanel.add(taskInfoPanel, BorderLayout.WEST);
        timerPanel.add(rightPanel, BorderLayout.EAST);

        return timerPanel;
    }


//    private JPanel createAddProjectPanel() {
//        JPanel addProjectPanel = new JPanel();
//        addProjectPanel.setPreferredSize(new Dimension(getWidth(), 40));
//        addProjectPanel.setLayout(new BorderLayout());
//        addProjectPanel.setBackground(ADD_PROJECT_PANEL_COLOR);
//        addProjectPanel.setOpaque(false); // Make panel transparent
//        addProjectPanel.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE));
//
//        ImageIcon addProjectIcon = loadImageIcon("icons/add-project-icon.png", 30, 30); // Adjust path and size as needed
//
//        JButton addProjectButton = new JButton();
//        if (addProjectIcon != null) {
//            addProjectButton.setIcon(addProjectIcon); // Set the icon
//        } else {
//            addProjectButton.setText("Add Project"); // Fallback text if icon not found
//        }
//
//        addProjectButton.setBackground(WARNING_COLOR);
//        addProjectButton.setPreferredSize(new Dimension(90, 30));
//        addProjectPanel.add(addProjectButton, BorderLayout.EAST);
//
//        return addProjectPanel;
//    }

    private JPanel createAddProjectPanel() {
        JPanel addProjectPanel = new JPanel();
        addProjectPanel.setPreferredSize(new Dimension(getWidth(), 40));
        addProjectPanel.setLayout(new BorderLayout());
        addProjectPanel.setBackground(ADD_PROJECT_PANEL_COLOR);
        addProjectPanel.setOpaque(false); // Make panel transparent
        addProjectPanel.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE));

        ImageIcon addProjectIcon = loadImageIcon("icons/add-project-icon.png", 30, 30); // Adjust path and size as needed

        JButton addProjectButton = new JButton();
        if (addProjectIcon != null) {
            addProjectButton.setIcon(addProjectIcon); // Set the icon
        } else {
            addProjectButton.setText("Add Project"); // Fallback text if icon not found
        }


        addProjectButton.addActionListener(e -> {
            showAddProjectDialog();
        });

        addProjectButton.setBackground(WARNING_COLOR);
        addProjectButton.setPreferredSize(new Dimension(90, 30));
        addProjectPanel.add(addProjectButton, BorderLayout.EAST);

        return addProjectPanel;
    }





    //side panel container
    private void addSidePanel(JPanel mainPanel) {
        // Side Panel with BorderLayout and margins
        JPanel sidePanelContainer = new JPanel(new BorderLayout());
        sidePanelContainer.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE)); // Top, Left, Bottom, Right
        sidePanelContainer.setBackground(PRIMARY_COLOR); // Match background to main panel

        JPanel sidePanel = new JPanel();
        sidePanel.setPreferredSize(new Dimension(144, getHeight()));
        sidePanel.setBackground(SECONDARY_COLOR);
        sidePanel.setLayout(new BoxLayout(sidePanel, BoxLayout.Y_AXIS));

        // Load icons (adjust paths and sizes as needed)
        ImageIcon icon1 = loadImageIcon("icons/hollow-clock-icon.png", 30, 30);
        ImageIcon icon2 = loadImageIcon("icons/dashboard-icon.png", 30, 30);
        ImageIcon icon3 = loadImageIcon("icons/setting-icon.png", 30, 30);
        ImageIcon icon4 = loadImageIcon("icons/clocklog-icon-with-name.png",80,80);

        // Create labels with icons
        JLabel label1 = new JLabel();
        JLabel label2 = new JLabel();
        JLabel label3 = new JLabel();
        JLabel label4 = new JLabel();


        if (icon1 != null) {
            label1.setIcon(icon1);
        }
        if (icon2 != null) {
            label2.setIcon(icon2);
        }
        if (icon3 != null) {
            label3.setIcon(icon3);
        }

        if (icon4 != null) {
            label4.setIcon(icon4);
        }

        // Align labels in the center
        label4.setAlignmentX(Component.CENTER_ALIGNMENT);
        label1.setAlignmentX(Component.CENTER_ALIGNMENT);
        label2.setAlignmentX(Component.CENTER_ALIGNMENT);
        label3.setAlignmentX(Component.CENTER_ALIGNMENT);


        // Add spacing and labels to the panel
        sidePanel.add(Box.createVerticalStrut(30)); // Space at the top
        sidePanel.add(label4);

        sidePanel.add(Box.createVerticalStrut(30)); // Space at the top
        sidePanel.add(label1);
        sidePanel.add(Box.createVerticalStrut(50)); // Space between icons
        sidePanel.add(label2);
        sidePanel.add(Box.createVerticalStrut(50)); // Space between icons
        sidePanel.add(label3);
        sidePanel.add(Box.createVerticalGlue()); // Pushes icons to the top and bottom

        // Add sidePanel to sidePanelContainer
        sidePanelContainer.add(sidePanel, BorderLayout.CENTER);

        // Add sidePanelContainer to mainPanel
        mainPanel.add(sidePanelContainer, BorderLayout.WEST);
    }

    // Method to create the folder panel with scroll functionality
    private JScrollPane createFolderPanel() {
        folderPanel = new JPanel();
        folderPanel.setPreferredSize(new Dimension(getWidth(), 150));
        folderPanel.setBackground(SECONDARY_COLOR);
        folderPanel.setLayout(new FlowLayout(FlowLayout.LEFT, 10, 10));
        folderPanel.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE));

        // Create JScrollPane for folderPanel
        JScrollPane folderScrollPane = new JScrollPane(folderPanel);
        folderScrollPane.setHorizontalScrollBarPolicy(JScrollPane.HORIZONTAL_SCROLLBAR_ALWAYS);
        folderScrollPane.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_NEVER);
        folderScrollPane.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE));

        folderScrollPane.getViewport().setOpaque(false);
        folderScrollPane.setOpaque(false);
        folderScrollPane.setBackground(SECONDARY_COLOR);

        // Customize the horizontal scrollbar
        JScrollBar horizontalScrollBar = folderScrollPane.getHorizontalScrollBar();
        horizontalScrollBar.setUnitIncrement(16); // Adjust horizontal scrollbar sensitivity
        horizontalScrollBar.setUI(new BasicScrollBarUI() {
            @Override
            protected void configureScrollBarColors() {
                this.thumbColor = SECONDARY_COLOR; // Set thumb color
                this.trackColor = Color.GRAY;      // Set track color (optional)
            }

            @Override
            protected JButton createDecreaseButton(int orientation) {
                return createInvisibleButton(); // Hide the left arrow button
            }

            @Override
            protected JButton createIncreaseButton(int orientation) {
                return createInvisibleButton(); // Hide the right arrow button
            }

            private JButton createInvisibleButton() {
                JButton button = new JButton();
                button.setPreferredSize(new Dimension(0, 0));
                button.setMinimumSize(new Dimension(0, 0));
                button.setMaximumSize(new Dimension(0, 0));
                return button;
            }
        });

        // Round corners of the JScrollPane
        folderScrollPane.setViewportBorder(BorderFactory.createLineBorder(SECONDARY_COLOR, 2, true)); // True for rounded corners

        return folderScrollPane;
    }


    private static ImageIcon loadImageIcon(String path, int width, int height) {
        // Load the image from the classpath
        ImageIcon icon = new ImageIcon(ClassLoader.getSystemResource(path));
        if (icon != null) {
            Image image = icon.getImage().getScaledInstance(width, height, Image.SCALE_SMOOTH);
            return new ImageIcon(image);
        } else {
            System.out.println("Image not found at path: " + path);
            return null;
        }
    }




    //serarch panel
//    private JPanel createSearchPanel() {
//        JPanel searchPanel = new JPanel();
//        searchPanel.setPreferredSize(new Dimension(getWidth(), 60));// Fixed height of 29 pixels
//        searchPanel.setBackground(SECONDARY_COLOR);
//        searchPanel.setLayout(new BorderLayout());
//        searchPanel.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE));
//
//        JTextField searchField = new JTextField();
//        searchField.setBackground(PRIMARY_COLOR);
//        searchField.setPreferredSize(new Dimension(180,35));// Set preferred size for text field
//
//        JButton addTaskButton = new JButton("Add Task");
//        addTaskButton.setBackground(WARNING_COLOR);
//
//        searchPanel.add(searchField, BorderLayout.WEST);
//        searchPanel.add(addTaskButton, BorderLayout.EAST);
//
//        return searchPanel;
//    }

    private JPanel createSearchPanel() {
        JPanel searchPanel = new JPanel();
        searchPanel.setPreferredSize(new Dimension(getWidth(), 60));// Fixed height of 29 pixels
        searchPanel.setBackground(SECONDARY_COLOR);
        searchPanel.setLayout(new BorderLayout());
        searchPanel.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE));

        JTextField searchField = new JTextField();
        searchField.setBackground(PRIMARY_COLOR);
        searchField.setPreferredSize(new Dimension(180,35));// Set preferred size for text field

        ImageIcon addTaskIcon = loadImageIcon("icons/add-project-icon.png", 30, 30); // Adjust path and size as needed

        JButton addTaskButton = new JButton();
        if (addTaskIcon != null) {
            addTaskButton.setIcon(addTaskIcon); // Set the icon
        } else {
            addTaskButton.setText("Add Task"); // Fallback text if icon not found
        }


        addTaskButton.addActionListener(e -> {
            showAddTaskDialog(currentProject);

        });

        addTaskButton.setBackground(WARNING_COLOR);
        addTaskButton.setPreferredSize(new Dimension(90, 20));

        searchPanel.add(searchField, BorderLayout.WEST);
        searchPanel.add(addTaskButton, BorderLayout.EAST);

        return searchPanel;
    }

//data from local tables
    private List<Project> fetchProjects() {
        List<Project> projectList = new ArrayList<>();
        String sql = "SELECT p.id AS projectId, p.name AS projectName, t.id AS taskId, " +
                "t.name AS taskName, t.description AS taskDescription, t.createDate AS taskCreateDate, " +
                "t.status AS taskStatus, t.timeSpent AS timeSpent,t.isRunning  " +
                "FROM projects p " +
                "JOIN tasks t ON p.id = t.projectId " +
                "JOIN user_tasks ut ON t.id = ut.taskId " +
                "WHERE ut.userId = ?";

        System.out.println("Starting fetchProjects method.");

        try (Connection conn = DriverManager.getConnection(DB_URL);
             PreparedStatement pstmt = conn.prepareStatement(sql)) {

            int userId = 1; // User ID to query
            pstmt.setInt(1, userId);
            System.out.println("Executing query with userId: " + userId);

            try (ResultSet rs = pstmt.executeQuery()) {
                if (!rs.isBeforeFirst()) {
                    System.out.println("No results found for the query.");
                } else {
                    System.out.println("Query returned results.");
                }

                Map<String, Project> projectMap = new HashMap<>();
                Task runningTask = null; // Track the running task
                Project selectedProject = null;

                while (rs.next()) {
                    String projectId = rs.getString("projectId");
                    String projectName = rs.getString("projectName");
                    String taskId = rs.getString("taskId");
                    String taskName = rs.getString("taskName");
                    String taskDescription = rs.getString("taskDescription");
                    String taskCreateDate = rs.getString("taskCreateDate");
                    String taskStatus = rs.getString("taskStatus");
                    int timeSpent = rs.getInt("timeSpent");
                    boolean isRunning = rs.getBoolean("isRunning"); // Read isRunning value


                    System.out.println("Processing projectId: " + projectId);
                    System.out.println("Project Name: " + projectName);
                    System.out.println("Task ID: " + taskId);
                    System.out.println("Task Name: " + taskName);
                    System.out.println("Task Description: " + taskDescription);
                    System.out.println("Task Create Date: " + taskCreateDate);
                    System.out.println("Task Status: " + taskStatus);
                    System.out.println("Task Duration: " + timeSpent);

                    Project project = projectMap.computeIfAbsent(projectId, k -> createProject(rs));

                    if (project != null) {
                        Task task = new Task(
                                projectId,
                                taskId,
                                taskName,
                                taskDescription,
                                taskCreateDate,
                                taskStatus,
                                timeSpent
                        );

                        if (isRunning) {
                            runningTask = task; // Update the running task
                            selectedProject = project; // Update the project of the running task
                        }

                        System.out.println("Adding task to project: " + taskId);

                        project.getTasks().add(task);



                        // Check if this is the selected project
//                        if (project.getId().equals(selectedProjectId)) {
//                            // Check if we need to find the selected task
//                            if (selectedTaskId != null && task.getId().equals(selectedTaskId)) {
//                                System.out.println("Found selected task: " + selectedTaskId);
//                                currentTask = task;
//                            }
//                        }
                    }
                }

                if (runningTask != null) {
                    currentTask = runningTask;
                    selectedProjectId = selectedProject != null ? selectedProject.getId() : null;
                    System.out.println("Found running task: " + runningTask.getId());
                    System.out.println("Selected project: " + selectedProjectId);
                } else {
                    System.out.println("No running tasks found.");
                }

                System.out.println("Adding projects to the list.");
                projectList.addAll(projectMap.values());
            } catch (SQLException e) {
                System.err.println("Error executing query: " + e.getMessage());
                e.printStackTrace();
            }
        } catch (SQLException e) {
            System.err.println("Error connecting to the database: " + e.getMessage());
            e.printStackTrace();
        }
        System.out.println("fetchProjects method completed.");
        return projectList;
    }

    private Project createProject(ResultSet rs) {
        try {
            String projectId = rs.getString("projectId");
            String projectName = rs.getString("projectName");
            System.out.println("Creating new project: " + projectId + " - " + projectName);
            return new Project(
                    projectId,
                    projectName,
                    new ArrayList<>()
            );
        } catch (SQLException e) {
            System.err.println("Error creating project: " + e.getMessage());
            e.printStackTrace();
            return null;
        }
    }






//  data from api
//
//    private List<Project> fetchProjects() {
//        List<Project> projectList = new ArrayList<>();
//        String apiUrl = "http://localhost:3000/getProjects";
//        String response = HttpUtil.sendGetRequest(apiUrl);
//
//        try {
//            JSONArray jsonArray = new JSONArray(response);
//            for (int i = 0; i < jsonArray.length(); i++) {
//                JSONObject jsonObject = jsonArray.getJSONObject(i);
//                List<Task> tasks = parseTasks(jsonObject.optJSONArray("tasks"));
//
//                Project project = new Project(
//                        jsonObject.getString("id"),
//                        jsonObject.getString("name"),
//                        tasks
//                );
//                projectList.add(project);
//
//                // Check if this is the selected project
//                if (project.getId().equals(selectedProjectId)) {
//
//                    // Check if we need to find the selected task
//                    if (selectedTaskId != null) {
//                        for (Task task : project.getTasks()) {
//                            if (task.getId().equals(selectedTaskId)) {
//                                currentTask = task;
//                                break;
//                            }
//                        }
//                    }
//                }
//            }
//
//        } catch (Exception e) {
//            e.printStackTrace();
//        }
//        return projectList;
//    }
//
//    private List<Task> parseTasks(JSONArray tasksArray) {
//        List<Task> tasks = new ArrayList<>();
//        if (tasksArray != null) {
//            for (int i = 0; i < tasksArray.length(); i++) {
//                JSONObject taskObject = tasksArray.getJSONObject(i);
//
//                // Extract values from JSON object
//                String taskId = taskObject.optString("id", UUID.randomUUID().toString());
//                String taskName = taskObject.optString("name", "New Task");
//                String taskDescription = taskObject.optString("description", "Description of the new task");
//                String taskCreateDate = taskObject.optString("createDate", "2024-07-25");
//                String taskStatus = taskObject.optString("status", "Open");
//                String taskDuration = taskObject.optString("duration", "00:00:00");
//                String projectId = taskObject.optString("id", UUID.randomUUID().toString());
//
//                // Create new Task object with extracted values
//                Task newTask = new Task(projectId,taskId, taskName, taskDescription, taskCreateDate, taskStatus, taskDuration);
//
//                // Add the new Task to the list
//                tasks.add(newTask);
//            }
//        }
//        return tasks;
//    }






    //task panel
    private JPanel createTaskPanel() {
        taskPanelR = new JPanel();
        taskPanelR.setBackground(SECONDARY_COLOR);
        taskPanelR.setLayout(new BorderLayout());
        taskPanelR.setBorder(BorderFactory.createEmptyBorder(MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE, MARGIN_SIZE));

        String[] columnNames = {"Name", "Description", "Create Date", "Status", "Total Time"};
        Object[][] data = {
                {"Task 1", "Description 1", "2024-07-23", "Open", "00:00:00"},
                {"Task 2", "Description 2", "2024-07-23", "In Progress", "00:00:00"}
        };

        taskTable = new JTable(data, columnNames);

        // Set default renderer for all cells
        TableCellRenderer renderer = new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
                Component c = super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);
                c.setBackground(Color.BLACK); // Set background color to black
                c.setForeground(Color.WHITE); // Set text color to white for contrast
                return c;
            }
        };
        taskTable.setDefaultRenderer(Object.class, renderer);

        // Set table header background color to black
        JTableHeader header = taskTable.getTableHeader();
        header.setPreferredSize(new Dimension(100, 40));

        header.setDefaultRenderer(new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
                JLabel label = (JLabel) super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);
                label.setBackground(SECONDARY_COLOR); // Set header background color to black
                label.setForeground(Color.WHITE); // Set header text color to white
                label.setHorizontalAlignment(SwingConstants.CENTER); // Center-align header text
                return label;
            }
        });


        taskTable.setDefaultRenderer(Object.class, new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
                JLabel label = (JLabel) super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);
                label.setBackground(Color.BLACK); // Set cell background color to black
                label.setForeground(Color.WHITE); // Set cell text color to white
                label.setHorizontalAlignment(SwingConstants.CENTER); // Center-align cell text
                label.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5)); // Add padding to cells
                return label;
            }
        });

        // Set table properties
        taskTable.setBackground(Color.BLACK); // Set background color for empty areas of the table
        taskTable.setForeground(Color.WHITE); // Set default text color
        taskTable.setGridColor(Color.GRAY); // Set grid line color
        taskTable.setSelectionBackground(Color.DARK_GRAY); // Set selection background color
        taskTable.setBorder(BorderFactory.createEmptyBorder()); // Remove cell borders

        // Remove table header border
        header.setBorder(BorderFactory.createEmptyBorder());

        // Add table to a scroll pane and remove scroll pane border
        JScrollPane scrollPane = new JScrollPane(taskTable);
        scrollPane.setBorder(BorderFactory.createEmptyBorder()); // Remove scroll pane border

//        frame.add(scrollPane);
//        frame.pack();
//        frame.setLocationRelativeTo(null);
//        frame.setVisible(true);

        JScrollPane tableScrollPane = new JScrollPane(taskTable);

        taskPanelR.add(tableScrollPane, BorderLayout.CENTER);

        return taskPanelR;
    }












    private void startGlobalEventListener() {
        Thread eventListenerThread = new Thread(() -> {
            try {
                listener = new GlobalEventListener();
                listener.openLogFile();
                listener.startPeriodicLogging();

                try {
                    // Register the native hook
                    GlobalScreen.registerNativeHook();

                    // Add keyboard listener first
                    GlobalScreen.addNativeKeyListener(listener);
                    GlobalScreen.addNativeMouseMotionListener(listener);

                    // Add a shutdown hook to unregister the native hook and close the log file
                    Runtime.getRuntime().addShutdownHook(new Thread(() -> {
                        try {
                            GlobalScreen.unregisterNativeHook();
                            listener.closeLogFile();
                        } catch (NativeHookException | IOException e) {
                            e.printStackTrace();
                        }
                    }));

                } catch (NativeHookException e) {
                    e.printStackTrace();
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        });

        eventListenerThread.start();
    }

    private void showAddProjectDialog() {
        JDialog addDialog = new JDialog(this, "Add New Project", true);
        addDialog.setSize(300, 200);
        addDialog.setLayout(new GridLayout(3, 1));

        JTextField nameField = new JTextField();
        JButton addProjectButton = new JButton("Add Project");

        addDialog.add(new JLabel("Project Name:"));
        addDialog.add(nameField);

        addProjectButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                String projectName = nameField.getText().trim();
                if (!projectName.isEmpty()) {
                    Project newProject = new Project(UUID.randomUUID().toString(), projectName, new ArrayList<>());
                    projects.add(newProject);
                    populateFolders();
                    selectedProjectId = newProject.getId();
                    showTasks(selectedProjectId);

                    // Send HTTP request to the Node.js API
                    String apiUrl = "http://localhost:3000/addProject";
                    String jsonPayload = "{\"name\":\"" + projectName + "\"}";
                    HttpUtil.sendPostRequest(apiUrl, jsonPayload);

                    addDialog.dispose();
                } else {
                    JOptionPane.showMessageDialog(addDialog, "Project name cannot be empty.", "Error", JOptionPane.ERROR_MESSAGE);
                }
            }
        });
        addDialog.add(addProjectButton);

        addDialog.setLocationRelativeTo(this);
        addDialog.setVisible(true);
    }



//    private void populateFolders() {
//        folderPanel.removeAll();
//        for (Project project : projects) {
//            JLabel folderLabel = new JLabel(project.getName());
//            folderLabel.setPreferredSize(new Dimension(150, 100));
//            folderLabel.setHorizontalAlignment(SwingConstants.CENTER);
//            folderLabel.setVerticalAlignment(SwingConstants.CENTER);
//            folderLabel.setOpaque(true);
//            folderLabel.setBackground(project.getId().equals(selectedProjectId) ? DARK_ORANGE : PRIMARY_COLOR);
//            folderLabel.setBorder(BorderFactory.createLineBorder(Color.BLACK));
//            folderLabel.addMouseListener(new java.awt.event.MouseAdapter() {
//                public void mouseClicked(java.awt.event.MouseEvent evt) {
//                    selectedProjectId = project.getId();
//                    populateFolders();  // Refresh folders to update selection
//                    showTasks(selectedProjectId);
//                }
//            });
//            folderPanel.add(folderLabel);
//        }
//        folderPanel.revalidate();
//        folderPanel.repaint();
//    }

    private void populateFolders() {
        folderPanel.removeAll();
        for (Project project : projects) {
            // Calculate task counts
            int completedCount = 0;
            int reviewCount = 0;
            int inProgressCount = 0;
            int toDoCount = 0;
            // Example data - replace with actual task fetching and counting
            for (Task task : project.getTasks()) {
                switch (task.getStatus()) {
                    case "Completed":
                        completedCount++;
                        break;
                    case "Review":
                        reviewCount++;
                        break;
                    case "Inprogress":
                        inProgressCount++;
                        break;
                    case "Todo":
                        toDoCount++;
                        break;
                }
            }

            // Create JPanel for folder content
            JPanel folderLabelPanel = new JPanel();
            folderLabelPanel.setPreferredSize(new Dimension(200, 120));
            folderLabelPanel.setOpaque(true);
            folderLabelPanel.setBackground(project.getId().equals(selectedProjectId) ? DARK_ORANGE : PRIMARY_COLOR);
            folderLabelPanel.setBorder(BorderFactory.createLineBorder(Color.BLACK));
            folderLabelPanel.setLayout(new GridBagLayout());

            folderLabelPanel.setBorder(BorderFactory.createEmptyBorder(0, 20, 0, 20)); // Top, left, bottom, right padding


            GridBagConstraints gbc = new GridBagConstraints();
            gbc.insets = new Insets(5, 5, 5, 5); // Padding for each component

            // Project Name
            gbc.gridx = 0;
            gbc.gridy = 0;
            gbc.gridwidth = 2;
            gbc.anchor = GridBagConstraints.CENTER;
            JLabel projectNameLabel = new JLabel(project.getName());
            projectNameLabel.setForeground(Color.WHITE);
            projectNameLabel.setFont(new Font("Arial", Font.BOLD, 14));
            folderLabelPanel.add(projectNameLabel, gbc);

            // Completed
            gbc.gridx = 0;
            gbc.gridy = 1;
            gbc.gridwidth = 1;
            gbc.anchor = GridBagConstraints.WEST;
            JLabel completedLabel = new JLabel("Completed: " + completedCount);
            completedLabel.setForeground(SUCCESS_COLOR);
            completedLabel.setFont(new Font("Arial", Font.BOLD, 12));
            folderLabelPanel.add(completedLabel, gbc);

            // Review
            gbc.gridx = 1;
            gbc.gridy = 1;
            gbc.anchor = GridBagConstraints.EAST;
            JLabel reviewLabel = new JLabel("Review: " + reviewCount);
            reviewLabel.setForeground(WARNING_COLOR);
            reviewLabel.setFont(new Font("Arial", Font.BOLD, 12));
            folderLabelPanel.add(reviewLabel, gbc);

            // In Progress
            gbc.gridx = 0;
            gbc.gridy = 2;
            gbc.anchor = GridBagConstraints.WEST;
            JLabel inProgressLabel = new JLabel("In Progress: " + inProgressCount);
            inProgressLabel.setForeground(INFO_COLOR);
            inProgressLabel.setFont(new Font("Arial", Font.BOLD, 12));
            folderLabelPanel.add(inProgressLabel, gbc);

            // To Do
            gbc.gridx = 1;
            gbc.gridy = 2;
            gbc.anchor = GridBagConstraints.EAST;
            JLabel toDoLabel = new JLabel("To Do: " + toDoCount);
            toDoLabel.setForeground(ERROR_COLOR);
            toDoLabel.setFont(new Font("Arial", Font.BOLD, 12));
            folderLabelPanel.add(toDoLabel, gbc);

            // Total Time Spent
            gbc.gridx = 0;
            gbc.gridy = 3;
            gbc.gridwidth = 2;
            gbc.anchor = GridBagConstraints.CENTER;
            JLabel totalTimeSpentLabel = new JLabel("Total Time Spent: " + 0);
            totalTimeSpentLabel.setForeground(ERROR_COLOR);
            totalTimeSpentLabel.setFont(new Font("Arial", Font.BOLD, 12));
            folderLabelPanel.add(totalTimeSpentLabel, gbc);

            // Add mouse listener for selection
            folderLabelPanel.addMouseListener(new java.awt.event.MouseAdapter() {
                public void mouseClicked(java.awt.event.MouseEvent evt) {
                    selectedProjectId = project.getId();
                    populateFolders();  // Refresh folders to update selection
                    showTasks(selectedProjectId);
                }
            });

            // Add the folder label panel to the folderPanel
            folderPanel.add(folderLabelPanel);
        }
        folderPanel.revalidate();
        folderPanel.repaint();
    }


    //
    //
    //
    //
    //







    private void showTasks(String projectId) {
        Project selectedProject = projects.stream().filter(p -> p.getId().equals(projectId)).findFirst().orElse(null);
        if (selectedProject == null || selectedProject.getTasks().isEmpty()) {
            JOptionPane.showMessageDialog(null, "No tasks available.", "Information", JOptionPane.INFORMATION_MESSAGE);
            return;
        }

        List<Task> tasks = selectedProject.getTasks();
        String[] columnNames = {"Task", "Description", "Create Date", "Status", "Total Time"};
        Object[][] taskData = new Object[tasks.size()][5];

        for (int i = 0; i < tasks.size(); i++) {
            Task task = tasks.get(i);
            taskData[i][0] = task;  // Store the Task object itself
            taskData[i][1] = task.getDescription();
            taskData[i][2] = task.getCreateDate().toString();
            taskData[i][3] = task.getStatus();
            taskData[i][4] = task.getTotalTime();
        }

        DefaultTableModel tableModel = new DefaultTableModel(taskData, columnNames) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return column == 0 || column == 3; // Editable for Task and Status columns
            }

            @Override
            public Class<?> getColumnClass(int column) {
                if (column == 0) return Task.class; // Custom class for task column
                return String.class;
            }
        };

        taskTable = new JTable(tableModel);

        // Set table header properties
        JTableHeader header = taskTable.getTableHeader();
        header.setPreferredSize(new Dimension(100, 40)); // Set header height
        header.setDefaultRenderer(new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
                JLabel label = (JLabel) super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);
                label.setBackground(PRIMARY_COLOR); // Set header background color to black
                label.setForeground(Color.WHITE); // Set header text color to white
                label.setHorizontalAlignment(SwingConstants.CENTER); // Center-align header text

                label.setBorder(BorderFactory.createEmptyBorder(10, 5, 10, 5)); // Add padding to header
                return label;
            }
        });

        taskTable.setDefaultRenderer(Object.class, new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
                JLabel label = (JLabel) super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);
                label.setBackground(PRIMARY_COLOR); // Set cell background color to black
                label.setForeground(Color.WHITE); // Set cell text color to white
                label.setHorizontalAlignment(SwingConstants.CENTER); // Center-align cell text
                label.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5)); // Add padding to cells
                return label;
            }
        });

        // Custom renderer and editor for the Task column
        taskTable.getColumnModel().getColumn(0).setCellRenderer(new TaskCellRenderer());
        taskTable.getColumnModel().getColumn(0).setCellEditor(new TaskCellEditor());
        taskTable.getColumnModel().getColumn(0).setPreferredWidth(300); // Adjust width for Task column if needed
        taskTable.setRowHeight(40); // Set row height to accommodate buttons and label
        taskTable.getColumnModel().getColumn(0).setPreferredWidth(100); // Set width for the first column
        taskTable.getColumnModel().getColumn(1).setPreferredWidth(200); // Set width for the second column


        // Set table properties
        taskTable.setBackground(PRIMARY_COLOR); // Set background color for empty areas of the table
        taskTable.setForeground(Color.WHITE); // Set default text color
        taskTable.setGridColor(SECONDARY_COLOR); // Set grid line color
//        taskTable.setSelectionBackground(SEARCH_COLOR); // Set selection background color
        taskTable.setBorder(BorderFactory.createEmptyBorder());
        // ComboBox for Status column
        JComboBox<String> statusComboBox = new JComboBox<>(new String[]{"To Do", "In Progress", "Completed", "Review"});
        taskTable.getColumnModel().getColumn(3).setCellEditor(new DefaultCellEditor(statusComboBox));


        // Set the current task row index
        if (currentTask != null) {
            currentTaskRowIndex = tasks.indexOf(currentTask);
        } else {
            currentTaskRowIndex = -1; // No task selected
        }

        JScrollPane tableScrollPane = new JScrollPane(taskTable);
        tableScrollPane.setBorder(BorderFactory.createEmptyBorder()); // Remove scroll pane border
        tableScrollPane.getViewport().setBackground(PRIMARY_COLOR);
        SwingUtilities.invokeLater(() -> {
            taskPanelR.removeAll();
            taskPanelR.add(tableScrollPane, BorderLayout.CENTER);
            taskPanelR.revalidate();
            taskPanelR.repaint();
        });
    }


//
    //
    //
    //
    //
    //
    //
    //
    //
    //
    //
    //
    //
    //
    //

    // Custom cell renderer for Task column
    private class TaskCellRenderer extends JPanel implements TableCellRenderer {
        private JLabel taskLabel;
        private JButton startButton;
        private JButton stopButton;

        public TaskCellRenderer() {
            setLayout(new FlowLayout(FlowLayout.LEFT));
            taskLabel = new JLabel();
            startButton = new JButton();
            stopButton = new JButton();

            // Set the background color to black
            setBackground(PRIMARY_COLOR);
            taskLabel.setForeground(Color.WHITE); // Set text color to white for better contrast

            // Load icons (adjust paths and sizes as needed)
            ImageIcon startIcon = loadImageIcon("icons/small-start-icon.png", 30, 30);
            ImageIcon stopIcon = loadImageIcon("icons/small-pause-con.png", 30, 30);

            if (startIcon != null) {
                startButton.setIcon(startIcon);
            }
            if (stopIcon != null) {
                stopButton.setIcon(stopIcon);
            }

            // Remove button text and set preferred size
            startButton.setText(null);
            stopButton.setText(null);
            startButton.setPreferredSize(new Dimension(30, 30));
            stopButton.setPreferredSize(new Dimension(30, 30));
            startButton.setBorderPainted(false);  // Remove the button border
            stopButton.setBorderPainted(false);   // Remove the button border
            startButton.setOpaque(true);
            startButton.setContentAreaFilled(true);
            stopButton.setOpaque(true);
            stopButton.setContentAreaFilled(true);

            // Set button background color
            startButton.setBackground(PRIMARY_COLOR);
            stopButton.setBackground(PRIMARY_COLOR);

            // Initial state
            stopButton.setEnabled(false);

            add(startButton);
            add(stopButton);
            add(taskLabel);

            // Action listeners
            startButton.addActionListener(e -> {
                Task task = (Task) startButton.getClientProperty("task");
                if (task != null) {
                    startTimer(task);
                    task.setRunning(true);
                    startButton.setEnabled(false);
                    stopButton.setEnabled(true);
                }
            });

            stopButton.addActionListener(e -> {
                Task task = (Task) stopButton.getClientProperty("task");
                if (task != null) {
                    stopTimer();
                    task.setRunning(false);
                    stopButton.setEnabled(false);
                    startButton.setEnabled(true);
                }
            });
        }

        @Override
        public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
            Task task = (Task) value;
            taskLabel.setText(task.getName());
            startButton.setEnabled(!task.isRunning());
            stopButton.setEnabled(task.isRunning());
            startButton.setVisible(!task.isRunning());
            stopButton.setVisible(task.isRunning());

            // Store task reference in buttons
            startButton.putClientProperty("task", task);
            stopButton.putClientProperty("task", task);

            return this;
        }
    }

    // Custom cell editor for Task column
    private class TaskCellEditor extends AbstractCellEditor implements TableCellEditor {
        private TaskCellRenderer taskRenderer;

        public TaskCellEditor() {
            taskRenderer = new TaskCellRenderer();
        }

        @Override
        public Component getTableCellEditorComponent(JTable table, Object value, boolean isSelected, int row, int column) {
            taskRenderer.getTableCellRendererComponent(table, value, isSelected, true, row, column);
            return taskRenderer;
        }

        @Override
        public Object getCellEditorValue() {
            return null; // Not used in this context
        }
    }


    //
    //
    //
    //
    //
    //
    //
    //
    //
    //
    //
    //







    private void showAddTaskDialog(Project project) {
        AddTaskModal dialog = new AddTaskModal(this, project.getId());
        dialog.setVisible(true);

        // Debug statement to check the status
        String status = dialog.getStatus();
        System.out.println("Debug: Status returned from AddTaskModal: " + status);

        // Check if the task was successfully added
        if ("Success".equals(status)) {
            Task newTask = dialog.getCreatedTask();

            // Debug statement to check the created task
            System.out.println("Debug: Created Task: " + newTask);

            if (newTask != null) {
                project.getTasks().add(newTask);
                showTasks(project.getId());
            }
        }
    }













//    private void showAddTaskDialog(Project project) {
//        JDialog addDialog = new JDialog(this, "Add New Task", true);
//        addDialog.setSize(300, 150);
//        addDialog.setLayout(new GridLayout(2, 1));
//
//        JTextField nameField = new JTextField();
//        JButton addTaskButton = new JButton("Add Task");
//        addTaskButton.setBackground(ADD_PROJECT_COLOR);
//
//
//        addDialog.add(new JLabel("Task Name:"));
//        addDialog.add(nameField);
//
//        addTaskButton.addActionListener(new ActionListener() {
//            @Override
//            public void actionPerformed(ActionEvent e) {
//                String taskName = nameField.getText().trim();
//                if (!taskName.isEmpty()) {
//                    // Assuming default values for the new fields
//                    String taskId = UUID.randomUUID().toString();
//                    String taskName2 = "New Task"; // Replace with actual task name input
//                    String taskDescription = "Description of the new task"; // Replace with actual description input
//                    String taskCreateDate = "2024-07-25"; // Current date or another date input
//                    String taskStatus = "Open"; // Default status or another status input
//                    String taskDuration = "00:00:00"; // Default duration
//
//                    Task newTask = new Task(taskId, taskName2, taskDescription, taskCreateDate, taskStatus, taskDuration);
//
//                    project.getTasks().add(newTask);
//                    showTasks(project.getId());
//                    addDialog.dispose();
//                } else {
//                    JOptionPane.showMessageDialog(addDialog, "Task name cannot be empty.", "Error", JOptionPane.ERROR_MESSAGE);
//                }
//            }
//        });
//        addDialog.add(addTaskButton);
//
//        addDialog.setLocationRelativeTo(this);
//        addDialog.setVisible(true);
//    }

    private void startTimer(Task task) {
//        initializeOrUpdateDatabase();
        System.out.println("Start timer: " + task.getName());

        stopTimer();  // Stop any existing timer
        currentTask = task;
        currentProject = projects.stream().filter(p -> p.getId().equals(selectedProjectId)).findFirst().orElse(null);
        currentTaskDetailsLabel.setText("Time Spent: " + currentTask.getTimeSpent());
        currentTaskLabel.setText(currentProject.getName());

        // Set task as running
        task.setRunning(true);

        // Determine the row index of the current task
        currentTaskRowIndex = -1;
        for (int i = 0; i < taskTable.getRowCount(); i++) {
            Task t = (Task) taskTable.getValueAt(i, 0); // Assuming the task is in the first column
            if (t.equals(currentTask)) {
                currentTaskRowIndex = i;
                break;
            }
        }
        lastDatabaseUpdate = System.currentTimeMillis(); // Initialize the last update time

        timer = new Timer();
        timer.scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                SwingUtilities.invokeLater(() -> updateTimeSpent());
            }
        }, 1000, 1000);
    }

    private void stopTimer() {
        if (timer != null) {
            timer.cancel();
        }
        if (currentTask != null) {
            currentTask.setRunning(false);
        }
        currentTask = null;
        currentProject = null;
        currentTaskDetailsLabel.setText("No task running");

        // Refresh task list or table to update button states
        showTasks(selectedProjectId);
    }


//    private void updateTimeSpent() {
//        if (currentTask != null) {
//            currentTask.incrementTimeSpent();
//            currentTaskDetailsLabel.setText(currentProject.getName() + " - " + currentTask.getName() + " - Time Spent: " + currentTask.getTimeSpent());
//            showTasks(selectedProjectId);  // Refresh task list to update time spent
//        }
//    }


    private void updateTimeSpent() {
        if (currentTask != null) {
            currentTask.incrementTimeSpent();
            currentTaskDetailsLabel.setText(currentTask.getName() + " - Time Spent: " + currentTask.getTimeSpent());

            if (currentTaskRowIndex >= 0 && taskTable != null) {
                // Update the time spent in the table cell for the current task
                SwingUtilities.invokeLater(() -> {
//                    taskTable.getModel().setValueAt(currentTask.getTotalTime(), currentTaskRowIndex, 4); // Update "Total Time" column
                    DefaultTableModel model = (DefaultTableModel) taskTable.getModel();
                    model.setValueAt(currentTask.getTotalTime(), currentTaskRowIndex, 4); // Update "Total Time" column
                    taskTable.revalidate();  // Ensure table layout is updated
                    taskTable.repaint();
                });
            }
            long currentTime = System.currentTimeMillis();
            if (currentTime - lastDatabaseUpdate >= UPDATE_INTERVAL_MS) {
                try {
                    initializeOrUpdateDatabase();
                } catch (Exception e) {
                    System.err.println("Error updating database: " + e.getMessage());
                }
                lastDatabaseUpdate = currentTime;
            }
        }
    }

    private int convertTimeStringToSeconds(String timeString) {
        try {
            String[] parts = timeString.split(":");
            if (parts.length != 3) {
                throw new IllegalArgumentException("Invalid time format. Expected HH:MM:SS.");
            }

            int hours = Integer.parseInt(parts[0]);
            int minutes = Integer.parseInt(parts[1]);
            int seconds = Integer.parseInt(parts[2]);

            return hours * 3600 + minutes * 60 + seconds;
        } catch (NumberFormatException e) {
            System.err.println("Error converting time string to seconds: Invalid number format.");
            return 0; // Default to 0 if there is a number format error
        } catch (IllegalArgumentException e) {
            System.err.println("Error converting time string to seconds: " + e.getMessage());
            return 0; // Default to 0 if there is an illegal argument
        }
    }



    private void initializeOrUpdateDatabase() {
        try {
            Class.forName("org.sqlite.JDBC"); // Load the SQLite JDBC driver
            try (Connection conn = DriverManager.getConnection(DB_URL)) {
                if (conn != null) {
                    try (Statement stmt = conn.createStatement()) {
                        // Create the tasks table if it does not exist
                        String createTableSQL = "CREATE TABLE IF NOT EXISTS tasks (" +
                                "id INTEGER PRIMARY KEY AUTOINCREMENT," +
                                "timeStamp INTEGER," +
                                "isRunning INTEGER," +
                                "timeSpent INTEGER)";
                        stmt.execute(createTableSQL);
                        System.out.println("Database and tasks table initialized.");

                        if (currentTask != null) {
                            // Ensure currentTask is initialized and has an ID
                            String taskIdString = currentTask.getId();
                            int taskId;
                            try {
                                taskId = Integer.parseInt(taskIdString);
                            } catch (NumberFormatException e) {
                                System.err.println("Error converting task ID to integer: " + e.getMessage());
                                return; // Exit the method if the ID is invalid
                            }

                            // Set all tasks to not running
                            String updateAllTasksSQL = "UPDATE tasks SET isRunning = 0 WHERE isRunning = 1";
                            try (PreparedStatement pstmt = conn.prepareStatement(updateAllTasksSQL)) {
                                pstmt.executeUpdate();
                            }

                            // Check if the task already exists in the database
                            String checkTaskSQL = "SELECT COUNT(*) FROM tasks WHERE id = ?";
                            try (PreparedStatement checkPstmt = conn.prepareStatement(checkTaskSQL)) {
                                checkPstmt.setInt(1, taskId);
                                try (ResultSet rs = checkPstmt.executeQuery()) {
                                    if (rs.next() && rs.getInt(1) > 0) {
                                        // Task exists, update the record
                                        updateTaskRecord(conn, taskId);
                                    } else {
                                        // Task does not exist, insert a new record
                                        insertTaskRecord(conn, taskId);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        } catch (ClassNotFoundException | SQLException e) {
            System.err.println("Error initializing or updating database: " + e.getMessage());
        }
    }

    private void updateTaskRecord(Connection conn, int taskId) {
        try {
            String sql = "UPDATE tasks SET timeStamp = ?, isRunning = ?, timeSpent = ? WHERE id = ?";
            try (PreparedStatement pstmt = conn.prepareStatement(sql)) {
                long currentTimeStamp = System.currentTimeMillis() / 1000; // timestamp in seconds
                int timeSpent = convertTimeStringToSeconds(currentTask.getTimeSpent());

                pstmt.setLong(1, currentTimeStamp);
                pstmt.setInt(2, currentTask.isRunning() ? 1 : 0);
                pstmt.setInt(3, timeSpent);
                pstmt.setInt(4, taskId); // Set the task ID to identify the record to update

                int rowsAffected = pstmt.executeUpdate();
                if (rowsAffected > 0) {
                    System.out.println("Database updated successfully.");
                } else {
                    System.out.println("No rows updated in the database. Check if the task ID exists.");
                }
            }
        } catch (SQLException e) {
            System.err.println("Error updating task record: " + e.getMessage());
        }
    }

    private void insertTaskRecord(Connection conn, int taskId) {
        try {
            String sql = "INSERT INTO tasks (id, timeStamp, isRunning, timeSpent) VALUES (?, ?, ?, ?)";
            try (PreparedStatement pstmt = conn.prepareStatement(sql)) {
                long currentTimeStamp = System.currentTimeMillis() / 1000; // timestamp in seconds

                pstmt.setInt(1, taskId); // Set task ID
                pstmt.setLong(2, currentTimeStamp); // Set current timestamp
                pstmt.setInt(3, currentTask.isRunning() ? 1 : 0); // Set running status
                pstmt.setInt(4, 0); // Set timeSpent to 0

                int rowsAffected = pstmt.executeUpdate();
                if (rowsAffected > 0) {
                    System.out.println("Task record initialized in the database.");
                } else {
                    System.out.println("No rows inserted into the database.");
                }
            }
        } catch (SQLException e) {
            System.err.println("Error inserting task record: " + e.getMessage());
        }
    }


    private void startGlobalTimer() {
//        if (isGlobalTimerRunning) {
//            return;
//        }


        startIdleTracking();
        globalStartTime = System.currentTimeMillis() - elapsedTimeBeforeStop;;
        globalTimer = new Timer();
        globalTimer.scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                SwingUtilities.invokeLater(() -> updateGlobalTimer());
            }
        }, 1000, 1000);
        isGlobalTimerRunning = true;
        if (startIconGlobalTimer != null) {
            startIconGlobalTimer.setVisible(false);
        }

        if (stopIconGlobalTimer != null) {
            stopIconGlobalTimer.setVisible(true);
        }

    }




    private void startIdleTracking() {
        if (idleTimer != null) {
            idleTimer.cancel();
        }
        idleTimer = new Timer();
        idleTimer.scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                long idleTime = listener.getIdleTime();
                System.out.println("Idle Time: " + idleTime / 1000 + " seconds");

                if (idleTime >= 5000000) {  // 15 seconds idle time
                    idleTimer.cancel();  // Stop further checks during the countdown
                    SwingUtilities.invokeLater(() -> showIdleAlert());
                }
            }
        }, 0, 5000); // Every 5 seconds
    }

    private void showIdleAlert() {
        JDialog idleDialog = new JDialog(this, "Idle Alert", true);
        idleDialog.setLayout(new BorderLayout());
        idleDialog.setSize(300, 150);
        idleDialog.setLocationRelativeTo(this);

        JLabel messageLabel = new JLabel("You have been idle for a while. Timer will stop in 60 seconds.");
        messageLabel.setHorizontalAlignment(SwingConstants.CENTER);
        idleDialog.add(messageLabel, BorderLayout.CENTER);

        JLabel countdownLabel = new JLabel("Time remaining: 60 seconds");
        countdownLabel.setHorizontalAlignment(SwingConstants.CENTER);
        idleDialog.add(countdownLabel, BorderLayout.NORTH);

        JButton cancelButton = new JButton("Cancel");
        cancelButton.addActionListener(e -> {
            idleDialog.dispose();
            startIdleTracking(); // Restart idle tracking
        });
        idleDialog.add(cancelButton, BorderLayout.SOUTH);

        Timer countdownTimer = new Timer();
        countdownTimer.scheduleAtFixedRate(new TimerTask() {
            int remainingTime = 60;  // 60 seconds countdown

            @Override
            public void run() {
                SwingUtilities.invokeLater(() -> {
                    if (remainingTime > 0) {
                        countdownLabel.setText("Time remaining: " + (--remainingTime) + " seconds");
                    } else {
                        countdownTimer.cancel();
                        idleDialog.dispose();
                        stopGlobalTimer();  // Stop the global timer
                    }
                });
            }
        }, 1000, 1000); // Update every second

        idleDialog.setVisible(true);
    }

    private void stopGlobalTimer() {
        if (globalTimer != null) {
            globalTimer.cancel();
            globalTimer = null;
        }
        elapsedTimeBeforeStop = System.currentTimeMillis() - globalStartTime;

        isGlobalTimerRunning = false;
        if (stopIconGlobalTimer != null) {
            stopIconGlobalTimer.setVisible(false);
        }

        if (startIconGlobalTimer != null) {
            startIconGlobalTimer.setVisible(true);
        }

        if (currentTask != null) {
            stopTimer();
        }
    }

    private void updateGlobalTimer() {
        long elapsedTime = System.currentTimeMillis() - globalStartTime;
        int seconds = (int) (elapsedTime / 1000) % 60;
        int minutes = (int) (elapsedTime / 60000) % 60;
        int hours = (int) (elapsedTime / 3600000);
        globalTimerLabel.setText(String.format("%02d:%02d:%02d", hours, minutes, seconds));
    }


    private void onWindowResize() {
        int frameWidth = getWidth();
        folderScrollPane.setBounds(20, 100, frameWidth - 40, 100);
        taskScrollPane.setBounds(20, 250, frameWidth - 40, getHeight() - 310);
        addButton.setBounds(frameWidth - 130, 10, 120, 30);
//        currentTaskPanel.setBounds(20, 10, frameWidth - 180, 80);
    }

//    public static void main(String[] args) {
//        SwingUtilities.invokeLater(new Runnable() {
//            public void run() {
//                new FolderList();
//            }
//        });
//    }
}